[tools]
go = "1.25"
golangci-lint = "2.8.0"
atlas = "1.0.0"
tbls = "1.92.3"
pre-commit = "4.5.1"
"go:github.com/go-jet/jet/v2/cmd/jet" = "2.14.1"

# =============================================================================
# Development
# =============================================================================

[tasks.dev]
description = "開発環境起動 (Docker + Air ホットリロード)"
run = "docker compose up"

[tasks.setup]
description = "開発環境セットアップ (pre-commit hooks インストール)"
run = "pre-commit install"

[tasks.lint]
description = "リンターを実行"
run = "golangci-lint run"
sources = ["**/*.go", ".golangci.yml"]

[tasks.test]
description = "テストを実行"
run = "go test -v ./..."

[tasks."test:coverage"]
description = "カバレッジ付きテストを実行"
run = "go test -v -coverprofile=coverage.out ./..."
outputs = ["coverage.out"]

# =============================================================================
# Code Generation
# =============================================================================

[tasks.gen]
description = "全コード生成 (jet + oapi)"
depends = ["gen:jet", "gen:oapi"]

[tasks."gen:jet"]
description = "jetでDBコード生成 (要: docker compose up -d oidc portal)"
run = """
jet -source=mariadb -dsn="mariadb://root:password@tcp(127.0.0.1:3307)/oidc" -path=./internal/repository
jet -source=mariadb -dsn="mariadb://root:password@tcp(127.0.0.1:3306)/portal" -path=./internal/repository
"""
sources = [
  "db/schema.sql",
  "db/portal-schema.sql",
]
outputs = [
  "internal/repository/oidc/",
  "internal/repository/portal/",
]

[tasks."gen:oapi"]
description = "OpenAPIでサーバー/モデル生成"
dir = "api"
run = """
go tool oapi-codegen --config oapi.server.yaml openapi.yaml
go tool oapi-codegen --config oapi.models.yaml openapi.yaml
"""
sources = [
  "openapi.yaml",
  "oapi.server.yaml",
  "oapi.models.yaml",
]
outputs = [
  "../internal/router/v1/gen/server.go",
  "../internal/router/v1/gen/models.go",
]

# =============================================================================
# Database Schema
# =============================================================================

[tasks."schema:apply"]
description = "全スキーマを適用"
depends = ["schema:apply:oidc", "schema:apply:portal"]

[tasks."schema:apply:oidc"]
description = "OIDCスキーマを適用"
dir = "db"
run = "atlas schema apply --env oidc --auto-approve"
hide = true

[tasks."schema:apply:portal"]
description = "Portalスキーマを適用"
dir = "db"
run = "atlas schema apply --env portal --auto-approve"
hide = true

# =============================================================================
# Documentation
# =============================================================================

[tasks.docs]
description = "全DBスキーマドキュメント生成"
depends = ["docs:oidc", "docs:portal"]

[tasks."docs:oidc"]
description = "OIDCスキーマドキュメント生成"
dir = "db"
run = "tbls doc --config tbls.oidc.yaml --rm-dist"
sources = ["tbls.oidc.yaml", "schema.sql"]
outputs = ["../docs/db/oidc/"]
hide = true

[tasks."docs:portal"]
description = "Portalスキーマドキュメント生成"
dir = "db"
run = "tbls doc --config tbls.portal.yaml --rm-dist"
sources = ["tbls.portal.yaml", "portal-schema.sql"]
outputs = ["../docs/db/portal/"]
hide = true

[tasks."tests"]
description = "tblsを使用してDBテーブル構成のドキュメントを生成。dev-upでmariadbコンテナを起動させておく必要がある"
env = { TARGET_DIR = "document/database" }
run = """
echo ${TARGET_DIR}
"""
