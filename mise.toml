[tools]
go = "1.25"
"golangci-lint" = "latest"
atlas = "latest"
tbls = "latest"
"go:github.com/sqlc-dev/sqlc/cmd/sqlc" = "latest"

[tasks."start:server"]
run = "go run ./cmd serve"

[tasks."schema:apply:oidc"]
description = "OIDCスキーマを適用"
dir = "db"
run = "atlas schema apply --env oidc --auto-approve"

[tasks."schema:apply:portal"]
description = "Portalスキーマを適用"
dir = "db"
run = "atlas schema apply --env portal --auto-approve"

[tasks."schema:apply"]
description = "全スキーマを適用"
depends = ["schema:apply:oidc", "schema:apply:portal"]

[tasks."schema:plan:oidc"]
description = "OIDCスキーマ変更計画を表示"
dir = "db"
run = "atlas schema apply --env oidc --dry-run"

[tasks."schema:plan:portal"]
description = "Portalスキーマ変更計画を表示"
dir = "db"
run = "atlas schema apply --env portal --dry-run"

[tasks."schema:plan"]
description = "全スキーマ変更計画を表示"
depends = ["schema:plan:oidc", "schema:plan:portal"]

[tasks.gen]
description = "全コード生成"
depends = ["sqlc", "oapi"]

[tasks.sqlc]
description = "sqlcコード生成"
dir = "db"
run = "sqlc generate"

[tasks.oapi]
description = "OpenAPIコード生成"
dir = "api"
run = """
go tool oapi-codegen --config oapi.server.yaml openapi.yaml
go tool oapi-codegen --config oapi.models.yaml openapi.yaml
"""

[tasks.lint]
description = "リンター実行"
run = "golangci-lint run"

[tasks."docs:oidc"]
description = "OIDCスキーマドキュメント生成"
dir = "db"
run = "tbls doc --config tbls.oidc.yaml --rm-dist"

[tasks."docs:portal"]
description = "Portalスキーマドキュメント生成"
dir = "db"
run = "tbls doc --config tbls.portal.yaml --rm-dist"

[tasks.docs]
description = "全スキーマドキュメント生成"
depends = ["docs:oidc", "docs:portal"]
